<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<title>Ekansh vs Kaju Katli & Kopra Pathi</title>
<script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.js"></script>
<style>
  html, body {
    margin: 0;
    padding: 0;
    background: #000;
    height: 100%;
    overflow: hidden;
  }
  #ui {
    position: absolute;
    bottom: 10px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 8px;
    z-index: 10;
  }
  button {
    font-size: 16px;
    padding: 10px 15px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    background: #333;
    color: #fff;
  }
  #retryBtn, #nextBtn {
    display: none;
    position: absolute;
    z-index: 20;
    background: #0b84ff;
    color: white;
    font-size: 18px;
    padding: 12px 20px;
    border-radius: 10px;
  }
  #retryBtn { top: 68%; left: 40%; transform: translate(-50%, -50%); }
  #nextBtn  { top: 68%; left: 60%; transform: translate(-50%, -50%); }
</style>
</head>
<body>

<div id="ui">
  <button id="magnetBtn">Magnet</button>
  <button id="invisibleBtn">Invisible</button>
  <button id="speedBtn">Speed Up</button>
  <button id="doubleBtn">Double Points</button>
</div>

<button id="retryBtn">RETRY</button>
<button id="nextBtn">NEXT</button>

<script>
const config = {
  type: Phaser.AUTO,
  width: window.innerWidth,
  height: window.innerHeight,
  backgroundColor: "#111",
  physics: { default: 'arcade', arcade: { debug: false } },
  scene: { preload, create, update }
};
const game = new Phaser.Game(config);

let player, goodBalls, badBalls;
let score = 0, level = 1, gameOver = false;
let scoreText, levelTarget = 500;
let ballSpeed = 140, spawnRate = 1100;
let powers = { magnet: false, invisible: false, speed: false, double: false };
let lastUsed = { magnet: 0, invisible: 0, speed: 0, double: 0 };
let highScore = localStorage.getItem('highScore') || 0;

function preload() {
  this.load.image('player', 'ekansh.png');
  this.load.image('good', 'kopra Pathi.png');
  this.load.image('danger', 'kaju Katli.png');
}

function create() {
  const w = this.scale.width;
  const h = this.scale.height;
  gameOver = false; score = 0; level = 1;
  levelTarget = 500;
  ballSpeed = 140; spawnRate = 1100;
  powers = { magnet: false, invisible: false, speed: false, double: false };

  player = this.physics.add.sprite(w / 2, h - 100, 'player')
    .setScale(0.18)
    .setCollideWorldBounds(true);
  player.nameText = this.add.text(player.x, player.y - 50, 'EKANSH', 
    { fontSize: '18px', fill: '#00ff00' }).setOrigin(0.5);

  goodBalls = this.physics.add.group();
  badBalls = this.physics.add.group();

  scoreText = this.add.text(20, 20, 'Score: 0  |  Target: ' + levelTarget,
    { fontSize: '22px', fill: '#fff' });

  // Move player with touch
  this.input.on('pointermove', pointer => { if (!gameOver) player.x = pointer.x; });

  // Spawn balls
  this.time.addEvent({ delay: spawnRate, loop: true, callback: () => spawnBall(this) });

  this.physics.add.overlap(player, goodBalls, collectGood, null, this);
  this.physics.add.overlap(player, badBalls, hitBad, null, this);

  setupPowerButtons();
}

function spawnBall(scene) {
  if (gameOver) return;
  const w = scene.scale.width;
  const isGood = Phaser.Math.Between(0, 1);
  const x = Phaser.Math.Between(40, w - 40);
  let ball, name;
  if (isGood) {
    ball = goodBalls.create(x, -20, 'good').setScale(0.18);
    name = scene.add.text(ball.x, ball.y - 25, 'KOPRA PATHI', { fontSize: '16px', fill: '#0ff' }).setOrigin(0.5);
  } else {
    ball = badBalls.create(x, -20, 'danger').setScale(0.18);
    name = scene.add.text(ball.x, ball.y - 25, 'KAJU KATLI', { fontSize: '16px', fill: '#ff5555' }).setOrigin(0.5);
  }
  ball.body.setVelocityY(ballSpeed + Phaser.Math.Between(0, 30));
  ball.nameText = name;
}

function update() {
  if (gameOver) return;

  goodBalls.children.iterate(b => {
    if (b && b.nameText) {
      b.nameText.setPosition(b.x, b.y - 25);
      if (b.y > this.scale.height + 40) { b.nameText.destroy(); b.destroy(); }
    }
  });
  badBalls.children.iterate(b => {
    if (b && b.nameText) {
      b.nameText.setPosition(b.x, b.y - 25);
      if (b.y > this.scale.height + 40) { b.nameText.destroy(); b.destroy(); }
    }
  });
  player.nameText.setPosition(player.x, player.y - 50);

  if (powers.magnet) {
    goodBalls.children.iterate(b => { if (b) b.x = Phaser.Math.Linear(b.x, player.x, 0.05); });
  }

  let currentSpeed = powers.speed ? ballSpeed * 1.2 : ballSpeed;
  goodBalls.children.iterate(b => { if (b) b.body.velocity.y = currentSpeed; });
  badBalls.children.iterate(b => { if (b) b.body.velocity.y = currentSpeed; });

  if (score >= levelTarget) {
    level++;
    levelTarget *= 2; // double each level requirement
    ballSpeed += 10;
    spawnRate = Math.max(500, spawnRate - 50);
    scoreText.setText('Score: ' + score + '  |  Target: ' + levelTarget);
  }
}

function collectGood(p, ball) {
  if (ball.nameText) ball.nameText.destroy();
  ball.destroy();
  score += powers.double ? 20 : 10;
  scoreText.setText('Score: ' + score + '  |  Target: ' + levelTarget);
}

function hitBad(p, ball) {
  if (powers.invisible) return;
  if (ball.nameText) ball.nameText.destroy();
  ball.destroy();
  endGameMsg('YOU LOST!');
}

function endGameMsg(msg) {
  gameOver = true;
  goodBalls.setVelocityY(0);
  badBalls.setVelocityY(0);
  goodBalls.children.iterate(b => { if (b.nameText) b.nameText.destroy(); });
  badBalls.children.iterate(b => { if (b.nameText) b.nameText.destroy(); });

  if (score > highScore) { highScore = score; localStorage.setItem('highScore', highScore); }
  scoreText.setText(score + ' pts | Level ' + level);

  const scene0 = game.scene.scenes[0];
  const message = `${msg}\nScore: ${score}\nHigh Score: ${highScore}`;
  const msgText = scene0.add.text(scene0.scale.width / 2, scene0.scale.height / 2 - 60, message,
    { fontSize: '26px', fill: '#fff', align: 'center', backgroundColor: 'rgba(0,0,0,0.5)', padding: { x: 20, y: 10 } }
  ).setOrigin(0.5);

  const retry = document.getElementById('retryBtn');
  const next = document.getElementById('nextBtn');
  retry.style.display = 'block';
  next.style.display = (msg === 'YOU WON!') ? 'block' : 'none';

  retry.onclick = () => { msgText.destroy(); retry.style.display = 'none'; next.style.display = 'none'; gameOver = false; scene0.scene.restart(); };
  next.onclick = () => { msgText.destroy(); retry.style.display = 'none'; next.style.display = 'none'; gameOver = false; scene0.scene.restart(); };
}

function setupPowerButtons() {
  const btns = ['magnet', 'invisible', 'speed', 'double'];
  btns.forEach(power => {
    const btn = document.getElementById(power + 'Btn');
    btn.onclick = () => activatePower(power, btn);
  });
}

function activatePower(powerName, btn) {
  const now = Date.now();
  const cooldown = 30000; // 30 seconds cooldown
  if (now - lastUsed[powerName] < cooldown) return; // still in cooldown
  if (powers[powerName]) return;

  lastUsed[powerName] = now;
  powers[powerName] = true;
  let remaining = 10;
  btn.innerText = powerName.toUpperCase() + ' ' + remaining + 's';
  const timer = setInterval(() => {
    remaining--;
    btn.innerText = powerName.toUpperCase() + ' ' + remaining + 's';
    if (remaining <= 0) {
      clearInterval(timer);
      powers[powerName] = false;
      btn.innerText = powerName.charAt(0).toUpperCase() + powerName.slice(1);
      // show cooldown after use
      let cd = 30;
      const cdTimer = setInterval(() => {
        cd--;
        btn.innerText = powerName.charAt(0).toUpperCase() + powerName.slice(1) + ' (' + cd + 's)';
        if (cd <= 0) {
          clearInterval(cdTimer);
          btn.innerText = powerName.charAt(0).toUpperCase() + powerName.slice(1);
        }
      }, 1000);
    }
  }, 1000);
}
</script>
</body>
</html>
